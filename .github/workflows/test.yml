name: ğŸ§ª Test Suite

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch: # Permite ejecutar manualmente

env:
  NODE_VERSION: '22'
  PNPM_VERSION: '10'

jobs:
  # Job de calidad de cÃ³digo
  code-quality:
    name: ğŸ” Code Quality
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'pnpm'
        
    - name: ğŸ“¦ Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: ${{ env.PNPM_VERSION }}
        
    - name: ğŸ“‹ Install dependencies
      run: pnpm install --frozen-lockfile
      
    - name: ğŸ§¹ Run linting
      run: pnpm lint
      
    - name: ğŸ¨ Check formatting
      run: pnpm format:check
      
    - name: ğŸ”’ Security audit
      run: pnpm audit --audit-level moderate
      
  # Job de tests unitarios
  unit-tests:
    name: ğŸ§ª Unit Tests
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'pnpm'
        
    - name: ğŸ“¦ Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: ${{ env.PNPM_VERSION }}
        
    - name: ğŸ“‹ Install dependencies
      run: pnpm install --frozen-lockfile
      
    - name: ğŸ§ª Run unit tests
      run: pnpm test
      
    - name: ğŸ“Š Run tests with coverage
      run: pnpm test:coverage
      
    - name: ğŸ“ˆ Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        directory: ./coverage/
        fail_ci_if_error: false
        verbose: true
        
    - name: ğŸ“‹ Upload coverage report
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: coverage/
        retention-days: 30
        
  # Job de tests de integraciÃ³n
  integration-tests:
    name: ğŸ”— Integration Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'pnpm'
        
    - name: ğŸ“¦ Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: ${{ env.PNPM_VERSION }}
        
    - name: ğŸ“‹ Install dependencies
      run: pnpm install --frozen-lockfile
      
    - name: ğŸ§ª Run integration tests
      run: pnpm test:integration
      
  # Job de tests E2E
  e2e-tests:
    name: ğŸŒ E2E Tests
    runs-on: ubuntu-latest
    needs: integration-tests
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'pnpm'
        
    - name: ğŸ“¦ Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: ${{ env.PNPM_VERSION }}
        
    - name: ğŸ“‹ Install dependencies
      run: pnpm install --frozen-lockfile
      
    - name: ğŸŒ Install Playwright Browsers
      run: npx playwright install --with-deps
      
    - name: ğŸ§ª Run E2E tests
      run: pnpm test:e2e
      
    - name: ğŸ“‹ Upload E2E test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: e2e-test-results
        path: |
          test-results/
          playwright-report/
        retention-days: 30
        
    - name: ğŸ“‹ Upload E2E screenshots
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: e2e-screenshots
        path: test-results/**/*.png
        retention-days: 30
        
  # Job de build y validaciÃ³n
  build-validation:
    name: ğŸ—ï¸ Build Validation
    runs-on: ubuntu-latest
    needs: e2e-tests
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'pnpm'
        
    - name: ğŸ“¦ Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: ${{ env.PNPM_VERSION }}
        
    - name: ğŸ“‹ Install dependencies
      run: pnpm install --frozen-lockfile
      
    - name: ğŸ—ï¸ Build project
      run: pnpm build
      
    - name: ğŸ“‹ Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: dist/
        retention-days: 30
        
  # Job de notificaciones
  notifications:
    name: ğŸ“¢ Notifications
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, e2e-tests, build-validation]
    if: always()
    
    steps:
    - name: ğŸ“Š Test Results Summary
      uses: actions/github-script@v7
      with:
        script: |
          const { data: checks } = await github.rest.checks.listForRef({
            owner: context.repo.owner,
            repo: context.repo.repo,
            ref: context.sha,
          });
          
          const testJobs = ['unit-tests', 'integration-tests', 'e2e-tests'];
          const results = {};
          
          for (const check of checks.check_runs) {
            if (testJobs.includes(check.name)) {
              results[check.name] = check.conclusion;
            }
          }
          
          const allPassed = Object.values(results).every(result => result === 'success');
          
          if (allPassed) {
            console.log('âœ… All tests passed successfully!');
          } else {
            console.log('âŒ Some tests failed:');
            Object.entries(results).forEach(([job, result]) => {
              console.log(`  ${job}: ${result === 'success' ? 'âœ…' : 'âŒ'}`);
            });
          }
