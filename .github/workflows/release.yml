name: ğŸ·ï¸ Release

on:
  push:
    tags:
      - 'v*' # Se activa con tags como v1.0.0, v1.2.3, etc.

env:
  NODE_VERSION: '22'
  PNPM_VERSION: '10'

jobs:
  # Job de validaciÃ³n de release
  validate-release:
    name: âœ… Validate Release
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'pnpm'
        
    - name: ğŸ“¦ Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: ${{ env.PNPM_VERSION }}
        
    - name: ğŸ“‹ Install dependencies
      run: pnpm install --frozen-lockfile
      
    - name: ğŸ§ª Run all tests
      run: pnpm test
      
    - name: ğŸ—ï¸ Build project
      run: pnpm build
      
    - name: ğŸ“‹ Upload release build
      uses: actions/upload-artifact@v4
      with:
        name: release-build-${{ github.ref_name }}
        path: dist/
        retention-days: 90
        
  # Job de creaciÃ³n de release
  create-release:
    name: ğŸš€ Create Release
    runs-on: ubuntu-latest
    needs: validate-release
    permissions:
      contents: write
      issues: write
      pull-requests: write
      
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'pnpm'
        
    - name: ğŸ“¦ Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: ${{ env.PNPM_VERSION }}
        
    - name: ğŸ“‹ Install dependencies
      run: pnpm install --frozen-lockfile
      
    - name: ğŸ—ï¸ Build project
      run: pnpm build
      
    - name: ğŸ“‹ Download release build
      uses: actions/download-artifact@v4
      with:
        name: release-build-${{ github.ref_name }}
        path: dist/
      
    - name: ğŸ“ Generate changelog
      id: changelog
      uses: actions/github-script@v7
      with:
        script: |
          const { data: commits } = await github.rest.repos.compareCommits({
            owner: context.repo.owner,
            repo: context.repo.repo,
            base: 'main',
            head: context.sha,
          });
          
          let changelog = `## ğŸš€ Release ${context.ref_name}\n\n`;
          changelog += `**Released:** ${new Date().toISOString().split('T')[0]}\n\n`;
          
          if (commits.commits.length > 0) {
            changelog += `### ğŸ“ Changes:\n\n`;
            
            const categories = {
              'feat': 'âœ¨ Features',
              'fix': 'ğŸ› Bug Fixes',
              'docs': 'ğŸ“š Documentation',
              'style': 'ğŸ¨ Style',
              'refactor': 'â™»ï¸ Refactoring',
              'test': 'ğŸ§ª Tests',
              'chore': 'ğŸ”§ Chores',
              'perf': 'âš¡ Performance',
              'ci': 'ğŸ‘· CI/CD',
              'build': 'ğŸ“¦ Build',
              'revert': 'âª Revert',
            };
            
            const categorizedCommits = {};
            
            for (const commit of commits.commits) {
              const message = commit.commit.message;
              const type = message.match(/^(\w+)(\(.+\))?:/)?.[1];
              
              if (type && categories[type]) {
                if (!categorizedCommits[type]) {
                  categorizedCommits[type] = [];
                }
                categorizedCommits[type].push(message.split('\n')[0]);
              } else {
                if (!categorizedCommits['other']) {
                  categorizedCommits['other'] = [];
                }
                categorizedCommits['other'].push(message.split('\n')[0]);
              }
            }
            
            for (const [type, messages] of Object.entries(categorizedCommits)) {
              if (type === 'other') {
                changelog += `### ğŸ“ Other Changes:\n`;
              } else {
                changelog += `### ${categories[type]}:\n`;
              }
              
              for (const message of messages) {
                const cleanMessage = message.replace(/^\w+(\(.+\))?:\s*/, '');
                changelog += `- ${cleanMessage}\n`;
              }
              changelog += '\n';
            }
          }
          
          changelog += `### ğŸ“¦ Installation:\n\n`;
          changelog += `\`\`\`bash\n`;
          changelog += `# Clone the repository\n`;
          changelog += `git clone https://github.com/${context.repo.owner}/${context.repo.repo}.git\n`;
          changelog += `cd ${context.repo.repo}\n`;
          changelog += `git checkout ${context.ref_name}\n`;
          changelog += `pnpm install\n`;
          changelog += `pnpm dev\n`;
          changelog += `\`\`\`\n\n`;
          
          changelog += `### ğŸ”— Links:\n\n`;
          changelog += `- ğŸŒ [Live Demo](https://${context.repo.owner}.github.io/${context.repo.repo}/)\n`;
          changelog += `- ğŸ“š [Documentation](https://${context.repo.owner}.github.io/${context.repo.repo}/docs/)\n`;
          changelog += `- ğŸ› [Report Issues](https://github.com/${context.repo.owner}/${context.repo.repo}/issues)\n`;
          
          core.setOutput('changelog', changelog);
          
    - name: ğŸ·ï¸ Create GitHub Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: Release ${{ github.ref_name }}
        body: ${{ steps.changelog.outputs.changelog }}
        draft: false
        prerelease: false
        
    - name: ğŸ“¦ Upload release assets
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./dist/
        asset_name: vonsim8-${{ github.ref_name }}.zip
        asset_content_type: application/zip
        
    - name: ğŸ“‹ Create release summary
      run: |
        echo "## ğŸ·ï¸ Release Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Version:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**Tag:** ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
        echo "**Released at:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Release URL:** https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**Live Demo:** https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/" >> $GITHUB_STEP_SUMMARY
        
  # Job de notificaciÃ³n
  notify-release:
    name: ğŸ“¢ Notify Release
    runs-on: ubuntu-latest
    needs: create-release
    if: always()
    
    steps:
    - name: ğŸ“Š Release notification
      uses: actions/github-script@v7
      with:
        script: |
          const { data: release } = await github.rest.repos.getReleaseByTag({
            owner: context.repo.owner,
            repo: context.repo.repo,
            tag: context.ref.replace('refs/tags/', ''),
          });
          
          console.log(`ğŸš€ Release created successfully!`);
          console.log(`ğŸ“¦ Version: ${release.tag_name}`);
          console.log(`ğŸ”— URL: ${release.html_url}`);
          console.log(`ğŸ“ Description: ${release.body ? release.body.substring(0, 100) + '...' : 'No description'}`);
          
          // Opcional: Enviar notificaciÃ³n a Discord/Slack/etc.
          // AquÃ­ puedes agregar integraciones con otros servicios 